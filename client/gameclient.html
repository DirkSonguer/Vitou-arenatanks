<!doctype html>
<html>

<head>
  <title>Server Test Client</title>
  <link rel="stylesheet" href="./css/main.css">
</head>

<body>
  <div id="main">
    <div id="createuser">
      <h3>User</h3>
      <button onclick="sendEvent('system', 'user', 'create', '')">Create new user</button>
    </div>

    <div id="itemhandling" style="display:none;">
      <h3>Items</h3>
      <button onclick="sendEvent('game', 'garage', 'getitems', '')">Show items in your garage</button>
      <ul id="garagelist"></ul>
      <button onclick="sendEvent('game', 'shop', 'getitems', '')">Show available shop items</button>
      <ul id="shoplist"></ul>
    </div>

    <div id="lobbyhandling" style="display:none;">
      <h3>Lobby</h3>
      <div id="createlobby">
        <button onclick="sendEvent('system', 'lobby', 'create', '')">Create new lobby</button>
      </div>

      <div id="showlobbies">
        <button onclick="sendEvent('system', 'lobby', 'list', '')">Show available lobbies</button>
        <ul id="lobbylist"></ul>
      </div>
    </div>

    <div id="currentlobby" style="display:none;">
      <ul id="currentlobbydata"></ul>
      <button class="green" onclick="sendEvent('system', 'lobby', 'confirm', '')">Confirm participation</button>
      <button onclick="sendEvent('system', 'lobby', 'leave', '')">Leave lobby</button>
    </div>

    <div id="game" style="display:none;">
      <canvas id="gamecanvas" width="1280" height="800">
        <script type="text/javascript" src="./js/game.js"></script>
      </canvas>
    </div>
  </div>

  <div id="gameui" class="ui-widget-content">
    <p id="gameui-playerstate">Not logged in</p>
    <p id="gameui-playermoney"></p>
    <p id="gameui-playertank"></p>
    <p id="gameui-playerweaponturret"></p>
    <p id="gameui-hitpoints"></p>
    <ul id="gameui-players"></ul>
    <p id="gameui-currentplayer"></p>
  </div>

  <div id="debug">
    <ul id="debugmessages"></ul>
  </div>

  <script src="./js/jquery-1.11.1.js"></script>
  <script src="./js/jquery-ui-1.11.4.js"></script>
  <script src="./js/socket.io-1.2.0.js"></script>
  <script>
    var socket = io('http://localhost:8888');
    
    var currentUserId = '';
    
        $(function() {
          $( "#gameui" ).draggable();
          $( "#debug" ).draggable();
        });
      
        $('form').submit(function(){
          return false;
        });      
        
        function sendEvent(t, m, a, d) {
          var msgType = JSON.stringify(t);
          var msgModule = JSON.stringify(m);
          var msgAction = JSON.stringify(a);
          var msgData = JSON.stringify(d);
          socket.emit('event', '{"type": ' + msgType + ', "module": ' + msgModule + ', "action": ' + msgAction + ', "data": ' + msgData + '}');          
        }
        
        socket.io.on('connect_error', function(err) {
          $('#main').css('display', 'none');
          $('#debugmessages').append($('<li>').text('Can\'t connect to server. Try reloading. ' + err));
        });
        
        socket.on('connect', function() { 
          $('#main').css('display', 'block');
        });        
        
        socket.on('message', function(msg){
          $('#debugmessages').prepend($('<li>').text(msg));

          var serverMessage = JSON.parse(msg);

          if ((serverMessage.module == 'user') && (serverMessage.action == 'created')) {
            currentUserId = serverMessage.data;
            $('#createuser').css('display', 'none');
            $('#lobbyhandling').css('display', 'block');
            $('#itemhandling').css('display', 'block');
            $('#gameui-playerstate').text('User logged in');
            sendEvent('system', 'user', 'getstate', '');
          }
          
          if ((serverMessage.module == 'user') && (serverMessage.action == 'state')) {
            $('#gameui-playermoney').text('Money: ' + serverMessage.data.userData.money);
            $('#gameui-playertank').text('Current tank: ' + serverMessage.data.userData.activeTank);
            $('#gameui-playerweaponturret').text('Current weapon turret: ' + serverMessage.data.userData.activeWeaponTurret);
          }
          
                    
          if ((serverMessage.module == 'shop') && (serverMessage.action == 'items')) {
            $('#shoplist').empty();
            	for (var i = 0, len = serverMessage.data.length; i < len; i++) {
                var itemObj = '<button class="green" onclick="sendEvent(\'game\', \'shop\', \'buyitem\', \'' + serverMessage.data[i].id + '\')">Buy ' + serverMessage.data[i].assemblage + ' ' + serverMessage.data[i].data.name + ' (Price: ' + serverMessage.data[i].data.price + ')</button>';
                $('#shoplist').append($('<li>').append(itemObj));
              }
          }
          
          if ((serverMessage.module == 'shop') && (serverMessage.action == 'buyitem')) {
            sendEvent('game', 'garage', 'getitems', '');
            sendEvent('system', 'user', 'getstate', '');
          }

          if ((serverMessage.module == 'garage') && (serverMessage.action == 'items')) {
            $('#garagelist').empty();
            	for (var i = 0, len = serverMessage.data.length; i < len; i++) {
                var itemObj = '<button class="green" onclick="sendEvent(\'game\', \'garage\', \'selectitem\', \'' + serverMessage.data[i].id + '\')">Select ' + serverMessage.data[i].assemblage + ' ' + serverMessage.data[i].data.name + '</button>';
                $('#garagelist').append($('<li>').append(itemObj));
              }
          }
          
          if ((serverMessage.module == 'garage') && (serverMessage.action == 'selecteditem')) {
            sendEvent('game', 'garage', 'getitems', '');
            sendEvent('system', 'user', 'getstate', '');
          }

          if ((serverMessage.module == 'lobby') && (serverMessage.action == 'created')) {
            $('#itemhandling').css('display', 'none');
            $('#lobbyhandling').css('display', 'none');
            $('#currentlobby').css('display', 'block');
            sendEvent('system', 'lobby', 'getstate', '');
          }

          if ((serverMessage.module == 'lobby') && (serverMessage.action == 'list')) {
            $('#lobbylist').empty();
            	for (var i = 0, len = serverMessage.data.length; i < len; i++) {
                var lobbyObj = '<button class="green" onclick="sendEvent(\'system\', \'lobby\', \'join\', \'' + serverMessage.data[i].id + '\')">Join lobby ' + serverMessage.data[i].id + '</button>';
                $('#lobbylist').append($('<li>').append(lobbyObj));
              }
          }

          if ((serverMessage.module == 'lobby') && (serverMessage.action == 'playerjoined')) {
            $('#itemhandling').css('display', 'none');
            $('#lobbyhandling').css('display', 'none');
            $('#currentlobby').css('display', 'block');
            sendEvent('system', 'lobby', 'getstate', '');
          }

          if ((serverMessage.module == 'lobby') && (serverMessage.action == 'playerconfirmed')) {
            sendEvent('system', 'lobby', 'getstate', '');
          }

          if ((serverMessage.module == 'lobby') && (serverMessage.action == 'playerleft')) {
            if (serverMessage.data == currentUserId) {
              $('#currentlobby').css('display', 'none');
              $('#lobbyhandling').css('display', 'block');
              $('#itemhandling').css('display', 'block');
            } else {            
              sendEvent('system', 'lobby', 'getstate', '');
            }
          }
          
          if ((serverMessage.module == 'lobby') && (serverMessage.action == 'state')) {
            $('#currentlobbydata').empty();
            	for (var i = 0, len = serverMessage.data.lobbyParticipants.length; i < len; i++) {
                  var playerState = 'Player: ' + serverMessage.data.lobbyParticipants[i];
                  if (serverMessage.data.lobbyParticipantsConfirmed.indexOf(serverMessage.data.lobbyParticipants[i]) > -1) {
                    playerState += ' (confirmed!)';
                  } else {
                    playerState += ' (unconfirmed!)';
                  }
                   $('#currentlobbydata').append($('<li>').text(playerState));
              }           
          }
          
          if ((serverMessage.module == 'game') && (serverMessage.action == 'created')) {
            $('#itemhandling').css('display', 'none');
            $('#currentlobby').css('display', 'none');
            $('#game').css('display', 'block');
            sendEvent('game', 'gameplay', 'getstate', '');
          }
                    
          if ((serverMessage.module == 'game') && (serverMessage.action == 'state')) {
                        
              $('#gameui-players').empty();
            	for (var i = 0, len = serverMessage.data.gameParticipants.length; i < len; i++) {
                var xPos = Math.floor(serverMessage.data.playerStates[i].tank.x / 3.2);
                var yPos = Math.floor(serverMessage.data.playerStates[i].tank.y / 3.2);
                console.log(serverMessage.data.playerStates[i].tank.x + ' -> ' + xPos);
                console.log(serverMessage.data.playerStates[i].tank.y + ' -> ' + yPos);
                $('#gameui-players').append($('<li>').text('Player ' + i + ': ' + serverMessage.data.gameParticipants[i]));
                // $('#gameui-players').append($('<li>').text('Player ' + i + ': ' + serverMessage.data.gameParticipants[i] + '(' + xPos + '/' + yPos) + ')');
                layer01[yPos][xPos] = 196;
              }
              
/*
{ "module": "game", "action": "state", "data": {"type":"GameObject","id":"27469c80-5921-11e5-97ee-377348e22e55",
"gameParticipants":["2468f800-5921-11e5-97ee-377348e22e55","216c59d0-5921-11e5-97ee-377348e22e55"],
"gameState":{"activePlayer":0,"round":1},
"playerStates":[
    {
      "tank":{"name":"Brutus","hitbox":10,"hitpoints":100,"x":55,"y":74,"speed":5,"price":1000},
      "weaponturret":{"name":"Lance","damage":50,"maxAngle":60,"maxPower":30,"price":1000}
    },
    {
       "tank":{"name":"Brutus","hitbox":10,"hitpoints":100,"x":73,"y":14,"speed":5,"price":1000},
       "weaponturret":{"name":"Lance","damage":50,"maxAngle":60,"maxPower":30,"price":1000}
    }],"globalState":""} }
*/              
              

            $('#gameui-currentplayer').text('Active player: ' + serverMessage.data.gameState.activePlayer);
            $('#gameui-hitpoints').text('Player hitpoints: ' + serverMessage.data.playerStates[serverMessage.data.gameState.activePlayer].tank.hitpoints);
            drawImage();
          }
        });
  </script>
</body>

</html>